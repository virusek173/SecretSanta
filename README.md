# ğŸ… Secret Santa

A Secret Santa gift exchange application with AI integration.

## âœ¨ Features

- ğŸ² Secret Santa assignment algorithm (cyclic graph)
- ğŸ¤– Personalized message generation using OpenAI GPT-5 (Polish language)
- ğŸ¨ Unique Christmas images generated by DALL-E 3
- ğŸ“§ Automated HTML email delivery with messages and images
- ğŸš€ Optimized for inbox delivery (anti-spam features)
- âœ… Input data validation (email, participants)
- ğŸ”’ Optional log encryption for privacy
- ğŸ§ª Unit tests (Jest)
- ğŸ¯ GitHub Actions CI/CD pipeline

## ğŸ“‹ Requirements

- Node.js >= 18
- TypeScript
- OpenAI account with API key
- SendGrid account (free tier: 100 emails/day)

## ğŸš€ Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd SecretSanta
```

2. Install dependencies:
```bash
npm install
```

3. Configure environment variables:
```bash
cp .env.example .env
```

Fill in the `.env` file with your credentials:
```env
OPENAI_API_KEY=sk-...
SENDGRID_API_KEY=SG.your_sendgrid_api_key_here
SENDGRID_FROM=your_verified_email@example.com
```

**Getting SendGrid API Key:**
1. Sign up for a free SendGrid account at https://sendgrid.com/free (100 emails/day forever free)
2. Go to Settings â†’ API Keys â†’ Create API Key
3. Choose "Full Access" or "Mail Send" permissions
4. Copy the API key (it only shows once!)
5. **Verify your sender to avoid spam folder:**

   **Option A (Recommended for production):** Domain Authentication
   - Go to Settings â†’ Sender Authentication â†’ Authenticate Your Domain
   - Click "Get Started" and follow the wizard
   - Add the DNS records (CNAME records) to your domain's DNS settings
   - Wait for verification (usually 24-48 hours)
   - âœ… **This significantly improves email deliverability and prevents spam filtering**

   **Option B (Quick, for testing only):** Single Sender Verification
   - Go to Settings â†’ Sender Authentication â†’ Verify Single Sender
   - Enter your email address and complete verification
   - âš ï¸ Note: Emails may still go to spam without domain authentication

4. Create participants file:
```bash
cp config/participants.json.example config/participants.json
```

Edit `config/participants.json` and add your participants:
```json
{
  "participants": [
    {
      "name": "John Doe",
      "email": "john@example.com",
      "description": "Loves fantasy books and good coffee"
    }
  ]
}
```

## ğŸ“– Usage

### Run with email sending:
```bash
npm run santa
```

### Dry-run (preview without sending):
```bash
npm run santa:dry-run
```

This will generate messages and images, and save them to the `output/` directory without sending any emails. Each participant will have:
- `{name}_message.txt` - The personalized message (Polish)
- `{name}_image.png` - The generated Christmas image

### Dry-run without images (faster, cheaper):
```bash
npm run santa:dry-run-no-images
```

This mode skips DALL-E image generation, saving time and API costs. Perfect for testing messages only.

### Advanced usage:
```bash
# Dry-run only
node dist/index.js --dry-run

# Skip images only (still sends emails)
node dist/index.js --no-images

# Encrypt names in console logs for privacy
node dist/index.js --encrypt-logs

# Combine multiple flags
node dist/index.js --dry-run --no-images --encrypt-logs
```

**Privacy Option:**
The `--encrypt-logs` flag masks participant names and emails in console output for privacy. Names are replaced with consistent hashes like `[USER-A1B2C3D4]`, and a mapping is shown at the end for reference.

### Tests:
```bash
npm test                # Run tests
npm run test:watch      # Watch mode
```

### Build:
```bash
npm run build
```

### Linting:
```bash
npm run lint          # Check code style
npm run lint:fix      # Auto-fix linting issues
```

## ğŸ—ï¸ Project Structure

```
SecretSanta/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ algorithm/
â”‚   â”‚   â””â”€â”€ secretSanta.ts         # Assignment algorithm
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ EmailService.ts        # Email sending (SendGrid)
â”‚   â”‚   â”œâ”€â”€ LlmService.ts          # Message generation (OpenAI)
â”‚   â”‚   â””â”€â”€ ImageService.ts        # Image generation (DALL-E)
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ index.ts               # TypeScript interfaces
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ validators.ts          # Validators
â”‚   â”‚   â””â”€â”€ encryption.ts          # Log encryption utilities
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ loadConfig.ts          # Configuration loading
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ algorithm/
â”‚   â”‚   â”‚   â””â”€â”€ secretSanta.test.ts # Algorithm tests
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â””â”€â”€ encryption.test.ts  # Encryption tests
â”‚   â”œâ”€â”€ SecretSantaApp.ts          # Main application
â”‚   â””â”€â”€ index.ts                   # Entry point
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml                 # GitHub Actions CI
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ participants.json          # Participants list (gitignored)
â”‚   â””â”€â”€ participants.json.example  # Example
â”œâ”€â”€ .env                            # Credentials (gitignored)
â”œâ”€â”€ .env.example                    # Template
â””â”€â”€ package.json
```

## ğŸ§ª Tests

The application includes 21 unit tests covering:

**Assignment Algorithm:**
- âœ… Input validation (min. 3 people, no duplicates)
- âœ… Each person gives to exactly one person
- âœ… Each person receives from exactly one person
- âœ… No one draws themselves
- âœ… Randomization of results
- âœ… Support for large groups (50+ people)

**Log Encryption:**
- âœ… Consistent name hashing
- âœ… Email masking
- âœ… Encryption mapping
- âœ… Custom key support

Run tests:
```bash
npm test
```

## ğŸ”’ Security

- Credentials stored in `.env` (not committed)
- Email address validation before sending
- Rate limiting between API calls (2s delay)
- Optional log encryption (`--encrypt-logs`) to mask participant names in console output
- All errors are handled and logged

## ğŸ“ Example Output

### Normal mode:
```
ğŸ… Secret Santa Application
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‚ Loading configuration...
âœ“ Loaded 5 participants

ğŸ² Performing Secret Santa assignment...
âœ“ Created 5 assignments

ğŸ“¨ Processing assignments...

[1/5] Processing Anna Kowalska â†’ Jan Nowak
   ğŸ¤– Generating message...
   âœ“ Message generated
   ğŸ¨ Generating image...
   âœ“ Image generated
   ğŸ“§ Sending email to anna.kowalska@example.com...
   âœ“ Email sent successfully
   â³ Waiting 2s before next request...

...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Secret Santa completed successfully!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### With `--encrypt-logs`:
```
ğŸ… Secret Santa Application
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”’ ENCRYPTED LOGS MODE - Names will be masked in logs

ğŸ“‚ Loading configuration...
âœ“ Loaded 5 participants

ğŸ² Performing Secret Santa assignment...
âœ“ Created 5 assignments

ğŸ“¨ Processing assignments...

[1/5] Processing [USER-A1B2C3D4] â†’ [USER-E5F6G7H8]
   ğŸ¤– Generating message...
   âœ“ Message generated
   ğŸ¨ Generating image...
   âœ“ Image generated
   ğŸ“§ Sending email to ***@a1b2c3d4.masked...
   âœ“ Email sent successfully
   â³ Waiting 2s before next request...

...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Secret Santa completed successfully!

ğŸ”‘ Encryption Mapping (for reference):
   Anna Kowalska â†’ [USER-A1B2C3D4]
   Jan Nowak â†’ [USER-E5F6G7H8]
   ...
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ¨ Example Email Message

Each person receives an HTML email containing:
- ğŸ… Secret Santa header with emoji
- ğŸ’Œ Personalized AI-generated message
- ğŸ–¼ï¸ Unique Christmas image (DALL-E)
- ğŸ“ Gift suggestion based on recipient's interests
- ğŸ”’ Reminder to keep it secret

## ğŸ“„ License

MIT

## ğŸ¤ Development

Improvement suggestions:
- [ ] Add exclusions (some people can't draw others)
- [ ] Web interface instead of CLI
- [ ] Drawing history (database)
- [ ] Multi-language support
- [ ] Custom email templates

## ğŸ› Bug Reports

If you find a bug, please create an issue in the repository.
