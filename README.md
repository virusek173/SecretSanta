# ğŸ… Secret Santa

A Secret Santa gift exchange application with AI integration.

## âœ¨ Features

- ğŸ² Secret Santa assignment algorithm (cyclic graph)
- ğŸ¤– Personalized message generation using OpenAI GPT-4 (Polish language)
- ğŸ¨ Unique Christmas images generated by DALL-E 3
- ğŸ“§ Automated HTML email delivery with messages and images
- âœ… Input data validation (email, participants)
- ğŸ§ª Unit tests (Jest)
- ğŸ”’ Secure credentials management (.env)
- ğŸ—ï¸ Dependency injection for easier testing
- ğŸ” Dry-run mode for preview without sending
- âš¡ Skip images mode to save costs and time
- ğŸš€ GitHub Actions CI/CD pipeline

## ğŸ“‹ Requirements

- Node.js >= 18
- TypeScript
- OpenAI account with API key
- SendGrid account (free tier: 100 emails/day)

## ğŸš€ Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd SecretSanta
```

2. Install dependencies:
```bash
npm install
```

3. Configure environment variables:
```bash
cp .env.example .env
```

Fill in the `.env` file with your credentials:
```env
OPENAI_API_KEY=sk-...
SENDGRID_API_KEY=SG.your_sendgrid_api_key_here
SENDGRID_FROM=your_verified_email@example.com
```

**Getting SendGrid API Key:**
1. Sign up for a free SendGrid account at https://sendgrid.com/free (100 emails/day forever free)
2. Go to Settings â†’ API Keys â†’ Create API Key
3. Choose "Full Access" or "Mail Send" permissions
4. Copy the API key (it only shows once!)
5. **Verify your sender:**
   - **Option A (Quick):** Settings â†’ Sender Authentication â†’ Verify Single Sender

4. Create participants file:
```bash
cp config/participants.json.example config/participants.json
```

Edit `config/participants.json` and add your participants:
```json
{
  "participants": [
    {
      "name": "John Doe",
      "email": "john@example.com",
      "description": "Loves fantasy books and good coffee"
    }
  ]
}
```

## ğŸ“– Usage

### Run with email sending:
```bash
npm run santa
```

### Dry-run (preview without sending):
```bash
npm run santa:dry-run
```

This will generate messages and images, and save them to the `output/` directory without sending any emails. Each participant will have:
- `{name}_message.txt` - The personalized message (Polish)
- `{name}_image.png` - The generated Christmas image

### Dry-run without images (faster, cheaper):
```bash
npm run santa:dry-run-no-images
```

This mode skips DALL-E image generation, saving time and API costs. Perfect for testing messages only.

### Advanced usage:
```bash
# Dry-run only
node dist/index.js --dry-run

# Skip images only (still sends emails)
node dist/index.js --no-images

# Both flags together
node dist/index.js --dry-run --no-images
```

### Tests:
```bash
npm test                # Run tests
npm run test:watch      # Watch mode
```

### Build:
```bash
npm run build
```

## ğŸ—ï¸ Project Structure

```
SecretSanta/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ algorithm/
â”‚   â”‚   â””â”€â”€ secretSanta.ts         # Assignment algorithm
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ EmailService.ts        # Email sending (nodemailer)
â”‚   â”‚   â”œâ”€â”€ LlmService.ts          # Message generation (OpenAI)
â”‚   â”‚   â””â”€â”€ ImageService.ts        # Image generation (DALL-E)
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ index.ts               # TypeScript interfaces
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ validators.ts          # Validators
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ loadConfig.ts          # Configuration loading
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â””â”€â”€ algorithm/
â”‚   â”‚       â””â”€â”€ secretSanta.test.ts # Algorithm tests
â”‚   â”œâ”€â”€ SecretSantaApp.ts          # Main application
â”‚   â””â”€â”€ index.ts                   # Entry point
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml                 # GitHub Actions CI
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ participants.json          # Participants list (gitignored)
â”‚   â””â”€â”€ participants.json.example  # Example
â”œâ”€â”€ .env                            # Credentials (gitignored)
â”œâ”€â”€ .env.example                    # Template
â””â”€â”€ package.json
```

## ğŸ§ª Tests

The application includes unit tests for the assignment algorithm:

- âœ… Input validation (min. 3 people, no duplicates)
- âœ… Each person gives to exactly one person
- âœ… Each person receives from exactly one person
- âœ… No one draws themselves
- âœ… Randomization of results
- âœ… Support for large groups (50+ people)

Run tests:
```bash
npm test
```

## ğŸ”’ Security

- Credentials stored in `.env` (not committed)
- Email address validation before sending
- Rate limiting between API calls (2s delay)
- Assignment results are not logged in plain text
- All errors are handled and logged

## ğŸ› ï¸ Gmail SMTP Configuration

1. Enable 2-Step Verification in Google Account
2. Generate App Password:
   - Google Account â†’ Security â†’ 2-Step Verification â†’ App passwords
3. Use the generated password as `SMTP_PASS` in `.env`

## ğŸ“ Example Output

```
ğŸ… Secret Santa Application
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‚ Loading configuration...
âœ“ Loaded 5 participants

ğŸ“§ Verifying SMTP connection...
âœ“ SMTP connection successful

ğŸ² Performing Secret Santa assignment...
âœ“ Created 5 assignments

ğŸ“¨ Processing assignments...

[1/5] Processing Anna Kowalska â†’ Jan Nowak
   ğŸ¤– Generating message...
   âœ“ Message generated
   ğŸ¨ Generating image...
   âœ“ Image generated
   ğŸ“§ Sending email to anna.kowalska@example.com...
   âœ“ Email sent successfully
   â³ Waiting 2s before next request...

...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Secret Santa completed successfully!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ¨ Example Email Message

Each person receives an HTML email containing:
- ğŸ… Secret Santa header with emoji
- ğŸ’Œ Personalized AI-generated message
- ğŸ–¼ï¸ Unique Christmas image (DALL-E)
- ğŸ“ Gift suggestion based on recipient's interests
- ğŸ”’ Reminder to keep it secret

## ğŸ“„ License

MIT

## ğŸ¤ Development

Improvement suggestions:
- [ ] Add exclusions (some people can't draw others)
- [ ] Web interface instead of CLI
- [ ] Drawing history (database)
- [ ] Multi-language support
- [ ] Custom email templates

## ğŸ› Bug Reports

If you find a bug, please create an issue in the repository.
